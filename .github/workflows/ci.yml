name: CI

on:
  push:
    branches:
      - main
      - staging/*
    paths-ignore:
      - '**/*.md'
      - 'compose.yaml'
      - '**/docs/**'
  pull_request:
    branches:
      - main
      - staging/*
  workflow_dispatch:
    inputs:
      threshold:
        description: 'Regression threshold fraction (e.g. 0.15 = 15%)'
        required: false
        default: '0.15'
      filter:
        description: 'BenchmarkDotNet filter pattern (e.g. * or *LogParser*)'
        required: false
        default: '*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1
      - name: Setup .NET
        uses: actions/setup-dotnet@v5.0.1
        with:
          global-json-file: global.json

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~\.nuget\packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('global.json', '**/*.csproj', '**/*.sln') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore

      - name: Format Check
        run: dotnet format --verify-no-changes --no-restore --verbosity normal

      - name: Build
        run: dotnet build --no-restore --configuration Debug --verbosity normal

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1
      - name: Setup .NET
        uses: actions/setup-dotnet@v5.0.1
        with:
          global-json-file: global.json
          
      - name: Retrieve Cached NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~\.nuget\packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('global.json', '**/*.csproj', '**/*.sln') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      - name: Restore
        run: dotnet restore
        
        # todo : add code coverage
      - name: Test
        run: dotnet test --no-restore --configuration Release --verbosity normal

  e2e-test:
    runs-on: ubuntu-latest
    needs: [ build, test ]
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare temp directory
        run: mkdir -p ./temp && chmod 777 ./temp

      - name: Build and run services with docker-compose
        run: |
          docker compose up --build --abort-on-container-exit
        timeout-minutes: 5

  perf-test:
    runs-on: ubuntu-latest
    needs: [ build, test ]
    if: (github.event_name == 'pull_request' && github.base_ref == 'main') || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Setup .NET
        uses: actions/setup-dotnet@v5.0.1
        with:
          global-json-file: global.json

      - name: Retrieve Cached NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~\.nuget\packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('global.json', '**/*.csproj', '**/*.sln') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore

      - name: Run benchmarks
        run: dotnet run --project LogWatcher.Benchmarks -c Release -- --job short --filter "${{ inputs.filter || '*' }}" --exporters fulljson github
        timeout-minutes: 10

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: BenchmarkDotNet.Artifacts/results/

      - name: Check for regressions
        run: |
          python benchmarks/compare.py \
            --baseline-dir benchmarks/baseline \
            --current-dir BenchmarkDotNet.Artifacts/results \
            --threshold ${{ inputs.threshold || '0.15' }}
